도커에 바로 이미지를 올려서 작업하다 보니 GPU가 자꾸 죽어서, 쿠버네티스에서 관리하기로 하셨다고 한다.

쿠버네티스 환경에서 GPU가 죽었을 때
1. root계정으로 접속 (192 서버에서는 admin으로 접속하지 말 것)
2. 콘솔에 k9s 입력
3. 만약 deployment가 뜰 경우, pod로 변경해야 한다!!! (명령어는 :pod)
   - deployment는 컨테이너 정보를 갖고 있고, 복제 및 라이프사이클을 관리한다.
   - pod가 죽었을 경우 deployment에서 재기동 시켜준다.
4. pod 환경이라면, ^D (delete) 한다
   - 동일한 이름의 pod가 없다면, deployment에서 자동으로 재배포한다.
   - 우리 pod 이름은 ai-service-jupyter-chat-(이하 생략)이니 그 위에 커서를 대고 ^D하기
5. jupyter 재기동
   - 지금 설정이 pod 재기동 되면 자동으로 jupyter가 붙게 되어 있는데, 혹시 안 될 경우
   - s : 주피터 접속
   - nohub jupyter lab --allow-root : 지금 환경은 conda 없이 바로 환경을 만들었기 때문에 nohub를 prefix로 붙인다.
   - 다 끝났으니 ^PQ로 컨테이너 안 끄고 나가기!
---

# 쿠버네티스 교과서
## MAKING
```
# 클러스터 내 모든 파드 목록 출력
kubectl get pods
# 상세 정보 확인
kubectl describe pod [확인할 파드 이름]
# 도커 컨테이너 삭제
docker container rm -f $(docker container ls -q --filter label=io.kubernetes.container.name=[삭제할 컨테이너명])
# 파드 상태 확인
kubectl get pod [파드 이름]
# 현재 컨테이너 확인
docker container ls
# 웹 애플리케이션 포트로 전달 (localhost:8080에서 확인 가능)
kubectl port-forward pod/[파드명] 8080:80
# 디플로이먼트 생성 -> 파드 생성
kubectl create deployment [디플로이먼트 이름] --image=[생성할 이미지]
# 매니페스트 파일로 애플리케이션 배포 (json / yml 파일)
kubectl apply -f [파일명 / URL]
# 새로운 디플로이먼트가 만든 파드 찾기
kubectl get pods -l app=[디플로이먼트 속 레이블 셀렉터의 app 이름]
```
## ACCESSING
#### 파드 내부와 연결할 대화형 쉘 실행
```
kubectl exec -it [파드명] sh
### 참고 ) 이후 명령어가 다음과 같이 바뀔 예정이라는 권고 메시지가 함께 뜬다 : kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.

######## 대화형 쉘 안에서 ########
# 파드 안에서 IP 주소 확인
/ # hostname -i
10.1.0.6
# 웹 애플리케이션의 동작 확인 (숫자 0 아니고 알파벳 O임!) : 파드 속 상황 파악하기에 용이 (파일 내용/서비스 연결/가상 네트워크로 API에 endpoint에 접속 되는지 ping 날리기 등)
/ # wget -O - http://localhost | head -n 4
#### 결과가 다음과 같이 뜹니다.
>>> Connecting to localhost (127.0.0.1:80)
>>> writing to stdout
-                    100% |*****************************************************************|   353  0:00:00 ETA<html>

  <body>
written to stdout
    <h1>
      Hello from Chapter 2!
### 종료하려면 exit 입력
```
#### 애플리케이션 로그 확인하기 (동작 중인 시스템일 때)
1. 쿠버네티스를 이용해 컨테이너의 최근 로그 2개 출력 : `kubectl logs --tail=2 [컨테이너명]`
2. 도커를 이용해 컨테이너에 접속해 실제 로그와 동일한지 확인: `docker container logs --tail=2 $(docker container ls -q --filter label=io.kubernetes.container.name=[컨테이너명])`
*파드도 이 방법으로 로그를 열람할 수 있다: `kubectl exec deploy/[앱 레이블명] -- sh -c 'wget -O - http://localhost > /dev/null` => 해당 파드의 로그 열람: `kubectl logs --tail=1 -l app=[앱 레이블명]`
*로컬 컴퓨터에 임시 디렉토리를 만들고, 컨테이너를 복사해올 수도 있다.
